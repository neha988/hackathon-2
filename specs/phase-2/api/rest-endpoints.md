# REST API Endpoints Specification

**Version**: 1.0.0
**Date**: 2025-12-15
**Base URL**: `http://localhost:8000` (development), `https://your-api.com` (production)

---

## Overview

This specification defines all RESTful API endpoints for the Todo application, including request/response schemas, authentication requirements, and error handling.

**API Conventions**:
- All task endpoints require authentication (JWT Bearer token)
- All endpoints use JSON for request/response bodies
- User ID in URL path must match authenticated user
- Proper HTTP status codes for all responses
- OpenAPI/Swagger documentation auto-generated by FastAPI

---

## Authentication Header

All authenticated endpoints require:

```
Authorization: Bearer <jwt_token>
Content-Type: application/json
```

---

## Endpoints Summary

| Method | Endpoint | Auth | Description |
|--------|----------|------|-------------|
| GET | `/health` | No | Health check |
| GET | `/api/{user_id}/tasks` | Yes | List all tasks |
| POST | `/api/{user_id}/tasks` | Yes | Create new task |
| GET | `/api/{user_id}/tasks/{id}` | Yes | Get task by ID |
| PUT | `/api/{user_id}/tasks/{id}` | Yes | Update task |
| DELETE | `/api/{user_id}/tasks/{id}` | Yes | Delete task |
| PATCH | `/api/{user_id}/tasks/{id}/complete` | Yes | Toggle completion |

---

## Endpoint Details

### 1. Health Check

**Purpose**: Verify API is running

```
GET /health
```

**Authentication**: Not required

**Response 200 OK**:
```json
{
  "status": "healthy",
  "timestamp": "2025-12-15T10:30:00Z"
}
```

**FastAPI Implementation**:
```python
# backend/app/routes/health.py
from fastapi import APIRouter
from datetime import datetime

router = APIRouter()

@router.get("/health")
async def health_check():
    return {
        "status": "healthy",
        "timestamp": datetime.utcnow().isoformat() + "Z"
    }
```

---

### 2. List Tasks

**Purpose**: Get all tasks for authenticated user

```
GET /api/{user_id}/tasks
```

**Authentication**: Required (JWT Bearer token)

**Path Parameters**:
- `user_id` (string, UUID): User ID (must match authenticated user)

**Query Parameters** (optional):
- `status` (string): Filter by status ("all" | "pending" | "completed") - Default: "all"
- `sort` (string): Sort field ("created" | "updated" | "title") - Default: "created"
- `order` (string): Sort order ("asc" | "desc") - Default: "desc"

**Example Request**:
```bash
GET /api/a0eebc99-9c0b-4ef8-bb6d-6bb9bd380a11/tasks?status=pending&sort=created&order=desc
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

**Response 200 OK**:
```json
[
  {
    "id": 1,
    "user_id": "a0eebc99-9c0b-4ef8-bb6d-6bb9bd380a11",
    "title": "Buy groceries",
    "description": "Milk, eggs, bread",
    "completed": false,
    "created_at": "2025-12-15T10:30:00Z",
    "updated_at": "2025-12-15T10:30:00Z"
  },
  {
    "id": 2,
    "user_id": "a0eebc99-9c0b-4ef8-bb6d-6bb9bd380a11",
    "title": "Finish homework",
    "description": null,
    "completed": false,
    "created_at": "2025-12-15T09:15:00Z",
    "updated_at": "2025-12-15T09:15:00Z"
  }
]
```

**Response 401 Unauthorized**:
```json
{
  "detail": "Missing or invalid authorization header"
}
```

**Response 403 Forbidden**:
```json
{
  "detail": "Access denied"
}
```

**FastAPI Implementation**:
```python
# backend/app/routes/tasks.py
from fastapi import APIRouter, Depends, HTTPException, Query
from sqlmodel import Session, select
from app.db import get_session
from app.models.task import Task
from app.middleware.auth import verify_jwt
from typing import List

router = APIRouter()

@router.get("/api/{user_id}/tasks", response_model=List[Task])
async def list_tasks(
    user_id: str,
    status: str = Query("all", regex="^(all|pending|completed)$"),
    sort: str = Query("created", regex="^(created|updated|title)$"),
    order: str = Query("desc", regex="^(asc|desc)$"),
    authenticated_user_id: str = Depends(verify_jwt),
    session: Session = Depends(get_session)
):
    # Verify user_id matches authenticated user
    if user_id != authenticated_user_id:
        raise HTTPException(status_code=403, detail="Access denied")

    # Build query
    query = select(Task).where(Task.user_id == user_id)

    # Filter by status
    if status == "pending":
        query = query.where(Task.completed == False)
    elif status == "completed":
        query = query.where(Task.completed == True)

    # Sort
    if sort == "created":
        query = query.order_by(Task.created_at.desc() if order == "desc" else Task.created_at)
    elif sort == "updated":
        query = query.order_by(Task.updated_at.desc() if order == "desc" else Task.updated_at)
    elif sort == "title":
        query = query.order_by(Task.title.desc() if order == "desc" else Task.title)

    tasks = session.exec(query).all()
    return tasks
```

---

### 3. Create Task

**Purpose**: Create a new task for authenticated user

```
POST /api/{user_id}/tasks
```

**Authentication**: Required (JWT Bearer token)

**Path Parameters**:
- `user_id` (string, UUID): User ID (must match authenticated user)

**Request Body** (TaskCreate schema):
```json
{
  "title": "Buy groceries",
  "description": "Milk, eggs, bread"  // optional
}
```

**Example Request**:
```bash
POST /api/a0eebc99-9c0b-4ef8-bb6d-6bb9bd380a11/tasks
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
Content-Type: application/json

{
  "title": "Buy groceries",
  "description": "Milk, eggs, bread"
}
```

**Response 201 Created**:
```json
{
  "id": 3,
  "user_id": "a0eebc99-9c0b-4ef8-bb6d-6bb9bd380a11",
  "title": "Buy groceries",
  "description": "Milk, eggs, bread",
  "completed": false,
  "created_at": "2025-12-15T11:00:00Z",
  "updated_at": "2025-12-15T11:00:00Z"
}
```

**Response 400 Bad Request** (validation error):
```json
{
  "detail": [
    {
      "loc": ["body", "title"],
      "msg": "field required",
      "type": "value_error.missing"
    }
  ]
}
```

**Response 401/403**: Same as List Tasks

**FastAPI Implementation**:
```python
from app.schemas.task import TaskCreate

@router.post("/api/{user_id}/tasks", response_model=Task, status_code=201)
async def create_task(
    user_id: str,
    task_data: TaskCreate,
    authenticated_user_id: str = Depends(verify_jwt),
    session: Session = Depends(get_session)
):
    if user_id != authenticated_user_id:
        raise HTTPException(status_code=403, detail="Access denied")

    task = Task(
        user_id=user_id,
        title=task_data.title,
        description=task_data.description
    )
    session.add(task)
    session.commit()
    session.refresh(task)
    return task
```

---

### 4. Get Single Task

**Purpose**: Get details of a specific task

```
GET /api/{user_id}/tasks/{id}
```

**Authentication**: Required (JWT Bearer token)

**Path Parameters**:
- `user_id` (string, UUID): User ID
- `id` (integer): Task ID

**Example Request**:
```bash
GET /api/a0eebc99-9c0b-4ef8-bb6d-6bb9bd380a11/tasks/1
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

**Response 200 OK**:
```json
{
  "id": 1,
  "user_id": "a0eebc99-9c0b-4ef8-bb6d-6bb9bd380a11",
  "title": "Buy groceries",
  "description": "Milk, eggs, bread",
  "completed": false,
  "created_at": "2025-12-15T10:30:00Z",
  "updated_at": "2025-12-15T10:30:00Z"
}
```

**Response 404 Not Found**:
```json
{
  "detail": "Task not found"
}
```

**FastAPI Implementation**:
```python
@router.get("/api/{user_id}/tasks/{task_id}", response_model=Task)
async def get_task(
    user_id: str,
    task_id: int,
    authenticated_user_id: str = Depends(verify_jwt),
    session: Session = Depends(get_session)
):
    if user_id != authenticated_user_id:
        raise HTTPException(status_code=403, detail="Access denied")

    task = session.get(Task, task_id)
    if not task or task.user_id != user_id:
        raise HTTPException(status_code=404, detail="Task not found")

    return task
```

---

### 5. Update Task

**Purpose**: Update task title and/or description

```
PUT /api/{user_id}/tasks/{id}
```

**Authentication**: Required (JWT Bearer token)

**Path Parameters**:
- `user_id` (string, UUID): User ID
- `id` (integer): Task ID

**Request Body** (TaskUpdate schema):
```json
{
  "title": "Buy groceries and fruits",  // optional
  "description": "Milk, eggs, bread, apples, bananas"  // optional
}
```

**Example Request**:
```bash
PUT /api/a0eebc99-9c0b-4ef8-bb6d-6bb9bd380a11/tasks/1
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
Content-Type: application/json

{
  "title": "Buy groceries and fruits"
}
```

**Response 200 OK**:
```json
{
  "id": 1,
  "user_id": "a0eebc99-9c0b-4ef8-bb6d-6bb9bd380a11",
  "title": "Buy groceries and fruits",
  "description": "Milk, eggs, bread",
  "completed": false,
  "created_at": "2025-12-15T10:30:00Z",
  "updated_at": "2025-12-15T11:15:00Z"
}
```

**Response 404 Not Found**: Same as Get Task

**FastAPI Implementation**:
```python
from app.schemas.task import TaskUpdate
from datetime import datetime

@router.put("/api/{user_id}/tasks/{task_id}", response_model=Task)
async def update_task(
    user_id: str,
    task_id: int,
    task_data: TaskUpdate,
    authenticated_user_id: str = Depends(verify_jwt),
    session: Session = Depends(get_session)
):
    if user_id != authenticated_user_id:
        raise HTTPException(status_code=403, detail="Access denied")

    task = session.get(Task, task_id)
    if not task or task.user_id != user_id:
        raise HTTPException(status_code=404, detail="Task not found")

    if task_data.title is not None:
        task.title = task_data.title
    if task_data.description is not None:
        task.description = task_data.description

    task.updated_at = datetime.utcnow()
    session.add(task)
    session.commit()
    session.refresh(task)
    return task
```

---

### 6. Delete Task

**Purpose**: Delete a task

```
DELETE /api/{user_id}/tasks/{id}
```

**Authentication**: Required (JWT Bearer token)

**Path Parameters**:
- `user_id` (string, UUID): User ID
- `id` (integer): Task ID

**Example Request**:
```bash
DELETE /api/a0eebc99-9c0b-4ef8-bb6d-6bb9bd380a11/tasks/1
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

**Response 200 OK**:
```json
{
  "message": "Task deleted successfully"
}
```

**Response 404 Not Found**: Same as Get Task

**FastAPI Implementation**:
```python
@router.delete("/api/{user_id}/tasks/{task_id}")
async def delete_task(
    user_id: str,
    task_id: int,
    authenticated_user_id: str = Depends(verify_jwt),
    session: Session = Depends(get_session)
):
    if user_id != authenticated_user_id:
        raise HTTPException(status_code=403, detail="Access denied")

    task = session.get(Task, task_id)
    if not task or task.user_id != user_id:
        raise HTTPException(status_code=404, detail="Task not found")

    session.delete(task)
    session.commit()
    return {"message": "Task deleted successfully"}
```

---

### 7. Toggle Task Completion

**Purpose**: Mark task as complete/incomplete

```
PATCH /api/{user_id}/tasks/{id}/complete
```

**Authentication**: Required (JWT Bearer token)

**Path Parameters**:
- `user_id` (string, UUID): User ID
- `id` (integer): Task ID

**Example Request**:
```bash
PATCH /api/a0eebc99-9c0b-4ef8-bb6d-6bb9bd380a11/tasks/1/complete
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

**Response 200 OK**:
```json
{
  "id": 1,
  "user_id": "a0eebc99-9c0b-4ef8-bb6d-6bb9bd380a11",
  "title": "Buy groceries",
  "description": "Milk, eggs, bread",
  "completed": true,  // toggled from false to true
  "created_at": "2025-12-15T10:30:00Z",
  "updated_at": "2025-12-15T11:20:00Z"
}
```

**FastAPI Implementation**:
```python
@router.patch("/api/{user_id}/tasks/{task_id}/complete", response_model=Task)
async def toggle_task_complete(
    user_id: str,
    task_id: int,
    authenticated_user_id: str = Depends(verify_jwt),
    session: Session = Depends(get_session)
):
    if user_id != authenticated_user_id:
        raise HTTPException(status_code=403, detail="Access denied")

    task = session.get(Task, task_id)
    if not task or task.user_id != user_id:
        raise HTTPException(status_code=404, detail="Task not found")

    task.completed = not task.completed
    task.updated_at = datetime.utcnow()
    session.add(task)
    session.commit()
    session.refresh(task)
    return task
```

---

## Error Response Format

All error responses follow this structure:

```json
{
  "detail": "Error message here"
}
```

**Common Error Codes**:
- **400 Bad Request**: Invalid input data (Pydantic validation failed)
- **401 Unauthorized**: Missing or invalid JWT token
- **403 Forbidden**: User ID mismatch (authenticated user != URL user_id)
- **404 Not Found**: Task doesn't exist or doesn't belong to user
- **500 Internal Server Error**: Unexpected server error

---

## CORS Configuration

**Backend Setup** (main.py):
```python
from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware
import os

app = FastAPI(title="Todo API", version="1.0.0")

origins = os.getenv("CORS_ORIGINS", "http://localhost:3000").split(",")

app.add_middleware(
    CORSMiddleware,
    allow_origins=origins,
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)
```

**Environment Variable**:
```bash
CORS_ORIGINS=http://localhost:3000,https://yourdomain.vercel.app
```

---

## OpenAPI/Swagger Documentation

FastAPI auto-generates interactive API documentation:

- **Swagger UI**: `http://localhost:8000/docs`
- **ReDoc**: `http://localhost:8000/redoc`
- **OpenAPI JSON**: `http://localhost:8000/openapi.json`

---

## Acceptance Criteria

- [ ] All 7 endpoints implemented (health + 6 task endpoints)
- [ ] JWT authentication required on all task endpoints
- [ ] User ID validation (URL matches JWT payload)
- [ ] Proper HTTP status codes returned
- [ ] Pydantic validation on request bodies
- [ ] Error responses use consistent format
- [ ] CORS configured for frontend origin
- [ ] OpenAPI docs accessible at /docs
- [ ] All endpoints tested with pytest
- [ ] Query parameters work (status, sort, order)

---

**Status**: âœ… Complete
**Next**: Create authentication specification
